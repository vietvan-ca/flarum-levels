(()=>{var e={n:t=>{var a=t&&t.__esModule?()=>t.default:()=>t;return e.d(a,{a}),a},d:(t,a)=>{for(var l in a)e.o(a,l)&&!e.o(t,l)&&Object.defineProperty(t,l,{enumerable:!0,get:a[l]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(()=>{"use strict";const t=flarum.core.compat["admin/app"];var a=e.n(t);function l(e,t){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},l(e,t)}function n(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,l(e,t)}const s=flarum.core.compat["admin/components/ExtensionPage"];var r=e.n(s);const i=flarum.core.compat["common/components/Button"];var o=e.n(i);const u=flarum.core.compat["common/components/LoadingIndicator"];var c=e.n(u);const v=flarum.core.compat["common/Component"];var d=function(e){function t(){return e.apply(this,arguments)||this}return n(t,e),t.prototype.view=function(){var e=this,t=this.attrs.level;return m("tr",{className:"LevelListItem"},m("td",{className:"LevelListItem-name"},m("span",{className:"LevelName"},t.attributes.name)),m("td",{className:"LevelListItem-xp"},t.attributes.xp_required),m("td",{className:"LevelListItem-color"},m("span",{className:"LevelColorDot",style:{backgroundColor:t.attributes.color||"#aaaaaa"}}),t.attributes.color||"—"),m("td",{className:"LevelListItem-special"},t.attributes.is_special?m("i",{className:"fas fa-check",title:a().translator.trans("vietvan-ca-flarum-levels.admin.levels.special_level")}):"—"),m("td",{className:"LevelListItem-order"},t.attributes.order),m("td",{className:"LevelListItem-actions"},m(o(),{className:"Button Button--icon",icon:"fas fa-pencil-alt",onclick:function(){return e.attrs.onEdit(t)}}),m(o(),{className:"Button Button--icon",icon:"fas fa-trash",onclick:function(){return e.attrs.onDelete(t)}})))},t}(e.n(v)());const p=flarum.core.compat["common/components/Modal"];var h=e.n(p);const f=flarum.core.compat["common/components/Switch"];var b=e.n(f);const g=flarum.core.compat["common/utils/Stream"];var L=e.n(g),N=function(e){function t(){return e.apply(this,arguments)||this}n(t,e);var l=t.prototype;return l.oninit=function(t){var a,l,n,s,r,i,o;e.prototype.oninit.call(this,t);var m=this.attrs.level||{};this.name=L()((null==(a=m.attributes)?void 0:a.name)||""),this.description=L()((null==(l=m.attributes)?void 0:l.description)||""),this.xpRequired=L()((null==(n=m.attributes)?void 0:n.xp_required)||0),this.color=L()((null==(s=m.attributes)?void 0:s.color)||"#0072E3"),this.icon=L()((null==(r=m.attributes)?void 0:r.icon)||""),this.isSpecial=L()(!(null==(i=m.attributes)||!i.is_special)),this.displayOrder=L()((null==(o=m.attributes)?void 0:o.display_order)||0),this.loading=!1},l.className=function(){return"EditLevelModal Modal--small"},l.title=function(){return this.attrs.level?a().translator.trans("vietvan-ca-flarum-levels.admin.levels.edit_title"):a().translator.trans("vietvan-ca-flarum-levels.admin.levels.new_level")},l.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.name")),m("input",{className:"FormControl",type:"text",bidi:this.name,disabled:this.loading})),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.description")),m("textarea",{className:"FormControl",bidi:this.description,disabled:this.loading})),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.xp_required")),m("input",{className:"FormControl",type:"number",min:"0",bidi:this.xpRequired,disabled:this.loading})),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.color")),m("input",{className:"FormControl",type:"color",bidi:this.color,disabled:this.loading})),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.icon")),m("input",{className:"FormControl",type:"text",placeholder:"fas fa-star",bidi:this.icon,disabled:this.loading})),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.order")),m("input",{className:"FormControl",type:"number",min:"0",bidi:this.displayOrder,disabled:this.loading})),m("div",{className:"Form-group"},m(b(),{state:this.isSpecial(),onchange:this.isSpecial},a().translator.trans("vietvan-ca-flarum-levels.admin.levels.special"))),m("div",{className:"Form-group"},o().component({type:"submit",className:"Button Button--primary",disabled:this.loading,loading:this.loading},a().translator.trans(this.attrs.level?"vietvan-ca-flarum-levels.admin.levels.save":"vietvan-ca-flarum-levels.admin.levels.add")))))},l.onsubmit=function(e){var t=this;e.preventDefault(),this.loading=!0;var l={name:this.name(),description:this.description(),xp_required:parseInt(this.xpRequired()),color:this.color(),icon:this.icon(),is_special:this.isSpecial(),order:parseInt(this.displayOrder())},n=this.attrs.level?a().forum.attribute("apiUrl")+"/levels/"+this.attrs.level.id:a().forum.attribute("apiUrl")+"/levels",s=this.attrs.level?"PATCH":"POST";console.log(n,s,l),fetch(n,{method:s,headers:{"Content-Type":"application/json","X-CSRF-Token":a().session.csrfToken},body:JSON.stringify({data:{type:"levels",attributes:l}})}).then((function(e){if(!e.ok)throw new Error("HTTP error "+e.status);return e.json()})).then((function(e){t.loading=!1,a().modal.close(),t.attrs.onSaved&&t.attrs.onSaved()})).catch((function(e){t.loading=!1,console.error("Error saving level:",e),m.redraw()}))},t}(h()),y=function(e){function t(){return e.apply(this,arguments)||this}n(t,e);var l=t.prototype;return l.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!0,this.levels=[],this.loadLevels()},l.loadLevels=function(){var e=this;a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/levels"}).then((function(t){e.levels=t.data||[],e.loading=!1,m.redraw()})).catch((function(t){e.loading=!1,m.redraw(),console.error("Error loading levels:",t)}))},l.content=function(){var e=this;return m("div",{className:"LevelsPage"},m("div",{className:"LevelsPage-header"},m("div",{className:"container"},m("h2",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.title")),m("p",{className:"LevelsPage-helpText"},a().translator.trans("vietvan-ca-flarum-levels.admin.levels.help_text")))),m("div",{className:"LevelsPage-body"},m("div",{className:"container"},this.loading?m(c(),null):m("div",{className:"LevelList"},m("div",{className:"LevelList-header"},m(o(),{className:"Button Button--primary",icon:"fas fa-plus",onclick:function(){return e.addLevel()}},a().translator.trans("vietvan-ca-flarum-levels.admin.levels.add"))),m("div",{className:"LevelList-items"},0===this.levels.length?m("div",{className:"LevelList-empty"},a().translator.trans("vietvan-ca-flarum-levels.admin.levels.empty")):m("table",{className:"LevelTable"},m("thead",null,m("tr",null,m("th",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.name")),m("th",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.xp_required")),m("th",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.color")),m("th",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.special")),m("th",null,a().translator.trans("vietvan-ca-flarum-levels.admin.levels.order")),m("th",null))),m("tbody",null,this.levels.map((function(t){return m(d,{level:t,onEdit:e.editLevel.bind(e),onDelete:e.deleteLevel.bind(e)})})))))))))},l.addLevel=function(){var e=this;a().modal.show(N,{onSaved:function(){return e.loadLevels()}})},l.editLevel=function(e){var t=this;a().modal.show(N,{level:e,onSaved:function(){return t.loadLevels()}})},l.deleteLevel=function(e){var t=this;confirm(a().translator.trans("vietvan-ca-flarum-levels.admin.levels.delete_confirmation"))&&a().request({method:"DELETE",url:a().forum.attribute("apiUrl")+"/levels/"+e.id}).then((function(){t.loadLevels()})).catch((function(e){console.error("Error deleting level:",e)}))},t}(r());function _(){return _=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var l in a)({}).hasOwnProperty.call(a,l)&&(e[l]=a[l])}return e},_.apply(null,arguments)}var x=function(e){function t(){return e.apply(this,arguments)||this}n(t,e);var l=t.prototype;return l.oninit=function(t){e.prototype.oninit.call(this,t),this.user=this.attrs.user,this.loading=!0,this.saving=!1,this.levels=[];var a=this.user.attribute("level");this.selectedLevelId=a?a.id:"",this.isManualLevel=this.user.attribute("is_manual_level")||!1,this.xpToAdd=0,this.loadLevels()},l.loadLevels=function(){var e=this;a().request({method:"GET",url:a().forum.attribute("apiUrl")+"/levels"}).then((function(t){e.levels=t.data.map((function(e){return _({id:e.id},e.attributes)})),e.levels.sort((function(e,t){return e.order-t.order})),e.loading=!1,m.redraw()})).catch((function(t){throw e.loading=!1,m.redraw(),t}))},l.className=function(){return"EditUserLevelModal Modal--small"},l.title=function(){return a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.title",{username:this.user.username()})},l.content=function(){var e=this;return this.loading?m("div",{className:"Modal-body"},m(c(),null)):m("div",{className:"Modal-body"},m("div",{className:"Form"},m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.current_xp")),m("p",{className:"helpText"},this.user.attribute("xp")||0," XP")),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.add_xp")),m("input",{className:"FormControl",type:"number",value:this.xpToAdd,onchange:function(t){e.xpToAdd=parseInt(t.target.value)||0},disabled:this.isManualLevel})),m("div",{className:"Form-group"},m(b(),{state:this.isManualLevel,onchange:function(t){e.isManualLevel=t}},a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.manual_level")),m("p",{className:"helpText"},a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.manual_level_help"))),m("div",{className:"Form-group"},m("label",null,a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.select_level")),m("select",{className:"FormControl",value:this.selectedLevelId,onchange:function(t){e.selectedLevelId=t.target.value},disabled:!this.isManualLevel},m("option",{value:""},a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.no_level")),this.levels.map((function(e){return m("option",{value:e.id,key:e.id},e.name," (",e.xp_required," XP)")})))),!this.isManualLevel&&!this.selectedLevelId&&m("div",{className:"Form-group"},m("p",{className:"helpText"},a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.auto_level_help"))),m("div",{className:"Form-group"},m(o(),{className:"Button Button--primary",type:"submit",loading:this.saving,disabled:this.saving},a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.submit")))))},l.onsubmit=function(e){var t=this;e.preventDefault(),this.saving=!0,a().request({method:"PATCH",url:a().forum.attribute("apiUrl")+"/users/"+this.user.id()+"/level",body:{data:{attributes:{is_manual_level:this.isManualLevel,level_id:this.isManualLevel?this.selectedLevelId:null}}}}).then((function(){if(!t.isManualLevel&&0!==t.xpToAdd)return a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/users/"+t.user.id()+"/xp",body:{data:{attributes:{amount:t.xpToAdd}}}});m.redraw()})).then((function(){t.saving=!1,a().modal.close(),m.redraw(),a().current.matches(UserListPage)&&"users.index"===a().current.get("routeName")&&a().current.one("onunload",(function(){a().store.find("users").then((function(){return m.redraw()}))}))})).catch((function(e){throw t.saving=!1,m.redraw(),e})),a().current instanceof UserListPage&&a().current.refresh()},t}(h());const F=flarum.core.compat["common/extend"],w=flarum.core.compat["admin/components/UserListPage"];var P=e.n(w);a().initializers.add("vietvan-ca-levels",(function(){a().extensionData.for("vietvan-ca-levels").registerPage(y).registerPermission({icon:"fas fa-chart-line",label:a().translator.trans("vietvan-ca-flarum-levels.admin.permissions.view_levels"),permission:"vietvan-ca-flarum-levels.view"},"view").registerPermission({icon:"fas fa-chart-line",label:a().translator.trans("vietvan-ca-flarum-levels.admin.permissions.manage_levels"),permission:"vietvan-ca-flarum-levels.manage"},"moderate"),(0,F.extend)(P().prototype,"columns",(function(e){e.add("level",{name:a().translator.trans("vietvan-ca-flarum-levels.admin.levels.title"),content:function(e){var t=e.attribute("level");return t?t.name:a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.no_level")}})})),(0,F.extend)(P().prototype,"userActionItems",(function(e,t){e.add("level",o().component({icon:"fas fa-chart-line",className:"Button UserList-levelBtn",onclick:function(){return a().modal.show(x,{user:t})},title:a().translator.trans("vietvan-ca-flarum-levels.admin.edit_user.title",{username:t.username()})},a().translator.trans("vietvan-ca-flarum-levels.admin.levels.title")))}))}))})(),module.exports={}})();
//# sourceMappingURL=admin.js.map